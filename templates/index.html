<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Vertica Workday Compare</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .tile { border:1px solid #ccc; padding:14px; border-radius:10px; margin-bottom: 16px; }
    .row { display:flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 420px; min-width: 360px; }
    .frame { border:1px solid #ddd; padding:12px; margin:10px 0; border-radius:8px; }
    .small { font-size: 12px; color:#444; }
    table { border-collapse: collapse; width: 100%; margin: 8px 0 12px 0; }
    th, td { border:1px solid #ddd; padding:6px; text-align:left; vertical-align: top; }
    th { background:#f6f6f6; }
    code { white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Vertica Workday Compare (localhost)</h1>

  <div class="tile">
    <h2>1) Table comparison</h2>
    <p class="small">Comparison writes output workbook automatically to <code>output/</code>.</p>

    <form method="post" action="/compare">
      <div class="row">
        <div class="col">
          <label>Left table</label><br/>
          <select name="left_table" id="cmp_left">
            {% for tm in table_maps %}<option value="{{ tm.left_table }}">{{ tm.left_table }}</option>{% endfor %}
          </select>
        </div>
        <div class="col">
          <label>Right table</label><br/>
          <select name="right_table" id="cmp_right">
            {% for tm in table_maps %}<option value="{{ tm.right_table }}">{{ tm.right_table }}</option>{% endfor %}
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Limit</label><br/>
          <input name="limit" type="number" value="500" />
        </div>
        <div class="col">
          <label><input type="checkbox" name="trim_strings" checked /> Trim strings</label><br/>
          <label><input type="checkbox" name="nullish_equal" checked /> Treat empty string as null</label><br/>
          <label>Number precision</label>
          <input name="number_precision" type="number" value="6" />
          <label><input type="checkbox" name="god_mode" {% if god_mode_default %}checked{% endif %}/> God mode</label>
        </div>
      </div>

      <button type="submit">Run comparison (output to Excel)</button>
    </form>

    <form method="get" action="/introspect" style="margin-top:10px;">
      <input type="hidden" name="left_table" id="i_left" />
      <input type="hidden" name="right_table" id="i_right" />
      <button type="submit" onclick="document.getElementById('i_left').value=document.getElementById('cmp_left').value;document.getElementById('i_right').value=document.getElementById('cmp_right').value;">Schema introspect + unmapped field report (JSON)</button>
    </form>

    {% if compare_result %}
      <h3>Compare: {{ compare_result.left_table }} vs {{ compare_result.right_table }}</h3>
      <p><strong>Workbook written:</strong> <code>{{ compare_result.result.output_file }}</code></p>
      <p>
        only in left: <strong>{{ compare_result.result.counts.only_in_left }}</strong> |
        only in right: <strong>{{ compare_result.result.counts.only_in_right }}</strong> |
        field differences: <strong>{{ compare_result.result.counts.field_differences }}</strong>
      </p>

      <h4>Unmapped fields (present in schema but not in field_map)</h4>
      <table>
        <thead>
          <tr>
            <th>Left table: not in field_map</th>
            <th>Right table: not in field_map</th>
          </tr>
        </thead>
        <tbody>
          {% set left_unmapped = compare_result.unmapped_fields.left_only_not_in_field_map %}
          {% set right_unmapped = compare_result.unmapped_fields.right_only_not_in_field_map %}
          {% set max_rows = [left_unmapped|length, right_unmapped|length]|max %}
          {% if max_rows == 0 %}
            <tr><td colspan="2"><em>No unmapped fields found for this table pair.</em></td></tr>
          {% else %}
            {% for i in range(max_rows) %}
              <tr>
                <td>{{ left_unmapped[i] if i < (left_unmapped|length) else "" }}</td>
                <td>{{ right_unmapped[i] if i < (right_unmapped|length) else "" }}</td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <div class="tile">
    <h2>2) Employee trace explorer</h2>
    <form method="post" action="/trace">
      <div class="row">
        <div class="col">
          <label>employee_id</label><br/>
          <input name="employee_id" value="{{ employee_id }}" />
        </div>
        <div class="col">
          <label><input type="checkbox" name="god_mode" {% if god_mode_default %}checked{% endif %}/> God mode</label>
        </div>
      </div>

      <h3>Tables + field pickers</h3>
      {% for tm in table_maps %}
        <div class="frame">
          <label>
            <input type="checkbox" name="left_table" value="{{ tm.left_table }}" />
            {{ tm.left_table }} ↔ {{ tm.right_table }}
          </label>

          <div class="row" style="margin-top:8px;">
            <div class="col">
              <strong>{{ tm.left_table }} fields</strong><br/>
              <select name="fields_left::{{ tm.left_table }}" multiple size="8" style="width:100%;">
                {% for fm in field_maps %}
                  {% if fm.left_table == tm.left_table and fm.right_table == tm.right_table %}
                    <option value="{{ fm.left_field }}">{{ fm.left_field }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="col">
              <strong>{{ tm.right_table }} fields</strong><br/>
              <select name="fields_right::{{ tm.right_table }}" multiple size="8" style="width:100%;">
                {% for fm in field_maps %}
                  {% if fm.left_table == tm.left_table and fm.right_table == tm.right_table %}
                    <option value="{{ fm.right_field }}">{{ fm.right_field }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      {% endfor %}

      <button type="submit">Trace employee across selected tables</button>
    </form>

    {% for f in trace_frames %}
      <div class="frame">
        <h3>{{ f.left_table }} ↔ {{ f.right_table }}</h3>
        <div class="row">
          <div class="col">
            <h4>LEFT: {{ f.left.table }}</h4>
            <div>SQL: <code>{{ f.left.sql }}</code></div>
            <div>Seconds: {{ f.left.seconds }}</div>
            <table>
              <thead>
                <tr>
                  {% for c in f.left.columns %}<th>{{ c }}</th>{% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in f.left.rows %}
                  <tr>
                    {% for c in f.left.columns %}<td>{{ row[c] }}</td>{% endfor %}
                  </tr>
                {% else %}
                  <tr><td colspan="{{ f.left.columns|length if f.left.columns else 1 }}"><em>No rows</em></td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="col">
            <h4>RIGHT: {{ f.right.table }}</h4>
            <div>SQL: <code>{{ f.right.sql }}</code></div>
            <div>Seconds: {{ f.right.seconds }}</div>
            <table>
              <thead>
                <tr>
                  {% for c in f.right.columns %}<th>{{ c }}</th>{% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in f.right.rows %}
                  <tr>
                    {% for c in f.right.columns %}<td>{{ row[c] }}</td>{% endfor %}
                  </tr>
                {% else %}
                  <tr><td colspan="{{ f.right.columns|length if f.right.columns else 1 }}"><em>No rows</em></td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</body>
</html>
